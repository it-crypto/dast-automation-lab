name: Maximal Authenticated DAST Workflow

on:
  workflow_dispatch:
  push:

jobs:
  dast:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------------------------------------
    # 1. Checkout repository
    # ---------------------------------------------------------
    - name: Checkout Repo
      uses: actions/checkout@v3

    # ---------------------------------------------------------
    # 2. Start Juice Shop in Docker
    # ---------------------------------------------------------
    - name: Start Juice Shop
      run: |
        docker run -d -p 3000:3000 --name juice-shop bkimminich/juice-shop
        echo "Waiting 30 sec for startup..."
        sleep 30

    # ---------------------------------------------------------
    # 3. Install Katana
    # ---------------------------------------------------------
    - name: Install Katana
      run: |
        wget https://github.com/projectdiscovery/katana/releases/download/v1.2.2/katana_1.2.2_linux_amd64.zip
        unzip -j katana_1.2.2_linux_amd64.zip katana -d /usr/local/bin
        chmod +x /usr/local/bin/katana

    # ---------------------------------------------------------
    # 4. Register + Login â†’ get JWT
    # ---------------------------------------------------------
    - name: Register & Login
      id: auth
      run: |
        EMAIL="user$(date +%s)@test.com"
        PASSWORD="Passw0rd!"

        echo "EMAIL=$EMAIL" >> $GITHUB_ENV

        curl -s -X POST http://localhost:3000/api/Users \
          -H "Content-Type: application/json" \
          -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\",\"securityQuestion\":{\"id\":1,\"answer\":\"test\"}}" > /dev/null

        TOKEN=$(curl -s -X POST http://localhost:3000/rest/user/login \
          -H "Content-Type: application/json" \
          -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\"}" | jq -r '.authentication.token')

        echo "TOKEN=$TOKEN" >> $GITHUB_ENV

    # ---------------------------------------------------------
    # 5. Authenticated Crawl ONLY (the important part)
    # ---------------------------------------------------------
    - name: Katana Authenticated Crawl
      run: |
        katana \
          -u http://localhost:3000 \
          -H "Authorization: Bearer $TOKEN" \
          -jsl \
          -silent \
          -d 7 \
          -o authenticated_urls.txt || true

        echo "Authenticated URLs:"
        wc -l authenticated_urls.txt

    # ---------------------------------------------------------
    # 6. Sanity check authentication works
    # ---------------------------------------------------------
    - name: Sanity Check Authenticated Endpoints
      run: |
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $TOKEN" http://localhost:3000/rest/user/whoami)
        [ "$STATUS" -eq 200 ] && echo "whoami OK" || (echo "whoami FAILED: $STATUS"; exit 1)

        STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $TOKEN" http://localhost:3000/rest/order-history)
        [ "$STATUS" -eq 200 ] && echo "order-history OK" || (echo "order-history FAILED: $STATUS"; exit 1)

    # ---------------------------------------------------------
    # 7. Upload authenticated URLs as artifact
    # ---------------------------------------------------------
    - name: Upload Crawled URLs
      uses: actions/upload-artifact@v5
      with:
        name: authenticated-urls
        path: authenticated_urls.txt

    # ---------------------------------------------------------
    # 8. ZAP FULL SCAN using authenticated URLs
    # ---------------------------------------------------------
    - name: Run ZAP Full Scan
      uses: zaproxy/action-full-scan@v0.13.0
      with:
        target: http://localhost:3000
        rules_file_name: ""
        allow_issue_writing: false
        cmd_options: "-zsp -config ajaxSpider.browserId=htmlunit -config api.key=12345 -config ajaxSpider.runOnlyLocal=true -config scanner.threadPerHost=3 -config view.mode=safe"
        urls_file_name: authenticated_urls.txt
        fail_action: false
        artifact_name: zap_fullscan_report
