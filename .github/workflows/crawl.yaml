name: Juice Shop Full DAST Crawl

on:
  workflow_dispatch:
  push:

jobs:
  full-crawl:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1. Checkout Repository
      # ---------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v3

      # ---------------------------------------------------------
      # 2. Start Juice Shop in Docker
      # ---------------------------------------------------------
      - name: Run Juice Shop in Docker
        run: |
          docker run -d -p 3000:3000 --name juice-shop bkimminich/juice-shop
          echo "Waiting for Juice Shop to fully start..."
          sleep 30

      # ---------------------------------------------------------
      # 3. Install Katana
      # ---------------------------------------------------------
      - name: Install Katana
        run: |
          wget https://github.com/projectdiscovery/katana/releases/download/v1.2.2/katana_1.2.2_linux_amd64.zip
          unzip -j katana_1.2.2_linux_amd64.zip katana -d /usr/local/bin
          chmod +x /usr/local/bin/katana

      # ---------------------------------------------------------
      # 4. Crawl Unauthenticated URLs (GET + JS-aware)
      # ---------------------------------------------------------
      - name: Crawl Unauthenticated
        run: |
          echo "Crawling unauthenticated URLs (GET + JS routes)..."
          katana -u http://localhost:3000 -d 7 -jsl -silent -o unauthenticated_urls.txt
          echo "Unauthenticated URL count:"
          wc -l unauthenticated_urls.txt

      # ---------------------------------------------------------
      # 5. Auto-register and login
      # ---------------------------------------------------------
      - name: Auto Register & Login
        id: auth
        run: |
          EMAIL="user$(date +%s)@test.com"
          PASSWORD="Passw0rd!"
          echo "EMAIL=$EMAIL" >> $GITHUB_ENV
          echo "PASSWORD=$PASSWORD" >> $GITHUB_ENV

          # Register
          curl -s -X POST http://localhost:3000/api/Users \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\",\"securityQuestion\":{\"id\":1,\"answer\":\"test\"}}" \
            > register_response.json
          cat register_response.json

          # Login to get JWT
          TOKEN=$(curl -s -X POST http://localhost:3000/rest/user/login \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\"}" \
            | jq -r '.authentication.token')
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

          # Quick JWT check
          curl -i -H "Authorization: Bearer $TOKEN" http://localhost:3000/rest/user/whoami

      # ---------------------------------------------------------
      # 6. Crawl Authenticated URLs (GET + JS-aware)
      # ---------------------------------------------------------
      - name: Crawl Authenticated
        run: |
          echo "Crawling authenticated URLs..."
          katana -u http://localhost:3000 -d 7 -jsl -silent \
            -H "Authorization: Bearer $TOKEN" \
            -o authenticated_urls.txt
          echo "Authenticated URL count:"
          wc -l authenticated_urls.txt

      # ---------------------------------------------------------
      # 7. POST endpoint discovery (manual form + API)
      # ---------------------------------------------------------
      - name: Discover POST-only endpoints
        run: |
          echo "Adding common POST endpoints..."
          cat <<EOF > post_endpoints.txt
http://localhost:3000/rest/user/change-password
http://localhost:3000/rest/user/reset-password
http://localhost:3000/rest/continue-code/apply/
http://localhost:3000/rest/continue-code-findIt/apply/
http://localhost:3000/rest/continue-code-fixIt/apply/
http://localhost:3000/rest/order-history
http://localhost:3000/rest/user/security-question?email=$EMAIL
http://localhost:3000/rest/saveLoginIp
EOF
          echo "POST endpoints count:"
          wc -l post_endpoints.txt

      # ---------------------------------------------------------
      # 8. Combine all URLs & filter authenticated-only
      # ---------------------------------------------------------
      - name: Combine and Filter Authenticated-only URLs
        run: |
          cat unauthenticated_urls.txt authenticated_urls.txt post_endpoints.txt | sort -u > all_urls.txt
          echo "Total unique URLs:"
          wc -l all_urls.txt

          # Authenticated-only
          grep -Fxv -f unauthenticated_urls.txt authenticated_urls.txt > auth_only_urls.txt
          echo "Authenticated-only URLs:"
          wc -l auth_only_urls.txt
          cat auth_only_urls.txt

      # ---------------------------------------------------------
      # 9. Upload all URL artifacts
      # ---------------------------------------------------------
      - name: Upload URL Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: juice-shop-urls
          path: |
            unauthenticated_urls.txt
            authenticated_urls.txt
            auth_only_urls.txt
            post_endpoints.txt
            all_urls.txt
