name: Maximal DAST Workflow

on:
  workflow_dispatch:
  push:

jobs:
  dast-crawl:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1. Checkout repository
      # ---------------------------------------------------------
      - name: Checkout Repo
        uses: actions/checkout@v3

      # ---------------------------------------------------------
      # 2. Start target app (Juice Shop example)
      # ---------------------------------------------------------
      - name: Run Target Application
        run: |
          docker run -d -p 3000:3000 --name juice-shop bkimminich/juice-shop
          echo "Waiting for application to start..."
          sleep 30

      # ---------------------------------------------------------
      # 3. Install Katana crawler
      # ---------------------------------------------------------
      - name: Install Katana
        run: |
          wget https://github.com/projectdiscovery/katana/releases/download/v1.2.2/katana_1.2.2_linux_amd64.zip
          unzip -j katana_1.2.2_linux_amd64.zip katana -d /usr/local/bin
          chmod +x /usr/local/bin/katana

      # ---------------------------------------------------------
      # 4. Register & login to get JWT
      # ---------------------------------------------------------
      - name: Auto Register & Login
        id: auth
        run: |
          EMAIL="user$(date +%s)@test.com"
          PASSWORD="Passw0rd!"
          echo "EMAIL=$EMAIL" >> $GITHUB_ENV
          echo "PASSWORD=$PASSWORD" >> $GITHUB_ENV

          curl -s -X POST http://localhost:3000/api/Users \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\",\"securityQuestion\":{\"id\":1,\"answer\":\"test\"}}" > /dev/null

          TOKEN=$(curl -s -X POST http://localhost:3000/rest/user/login \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\"}" \
            | jq -r '.authentication.token')
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

          # Quick test
          curl -i -H "Authorization: Bearer $TOKEN" http://localhost:3000/rest/user/whoami

      # ---------------------------------------------------------
      # 5. Crawl unauthenticated routes
      # ---------------------------------------------------------
      - name: Crawl Unauthenticated Routes
        run: |
          touch unauthenticated_urls.txt
          katana -u http://localhost:3000 -d 7 -jsl -silent -o unauthenticated_urls.txt || true
          echo "Unauthenticated URL count:"
          wc -l unauthenticated_urls.txt

      # ---------------------------------------------------------
      # 6. Crawl authenticated routes
      # ---------------------------------------------------------
      - name: Crawl Authenticated Routes
        run: |
          touch authenticated_urls.txt
          katana -u http://localhost:3000 -d 7 -jsl -silent -H "Authorization: Bearer $TOKEN" -o authenticated_urls.txt || true
          echo "Authenticated URL count:"
          wc -l authenticated_urls.txt

      # ---------------------------------------------------------
      # 7. Extract URLs from JS / static assets (SPAs)
      # ---------------------------------------------------------
      - name: Extract JS / Asset URLs
        run: |
          mkdir -p js_urls
          echo "Downloading main JS/CSS assets..."
          wget -q -O main.js http://localhost:3000/main.js || true
          wget -q -O runtime.js http://localhost:3000/runtime.js || true
          wget -q -O polyfills.js http://localhost:3000/polyfills.js || true
          wget -q -O vendor.js http://localhost:3000/vendor.js || true

          # Extract HTTP/HTTPS endpoints from JS files
          grep -Eo 'https?://[a-zA-Z0-9./?=_-]+' *.js 2>/dev/null > js_urls.txt || true
          grep -Eo '/[a-zA-Z0-9./?=_-]+' *.js 2>/dev/null >> js_urls.txt || true

          # Combine & deduplicate JS URLs
          sort -u js_urls.txt > js_urls_unique.txt
          echo "Extracted JS/static URLs:"
          wc -l js_urls_unique.txt

      # ---------------------------------------------------------
      # 8. Combine all URLs safely
      # ---------------------------------------------------------
      - name: Combine All URLs
        run: |
          touch unauthenticated_urls.txt authenticated_urls.txt js_urls_unique.txt
          cat unauthenticated_urls.txt authenticated_urls.txt js_urls_unique.txt 2>/dev/null | sort -u > all_urls.txt
          echo "Total unique URLs discovered:"
          wc -l all_urls.txt

          # Authenticated-only URLs
          grep -Fxv -f unauthenticated_urls.txt authenticated_urls.txt || true > auth_only_urls.txt
          echo "Authenticated-only URLs:"
          wc -l auth_only_urls.txt

      # ---------------------------------------------------------
      # 9. Upload URL artifacts
      # ---------------------------------------------------------
      - name: Upload URL Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: dast-urls
          path: |
            unauthenticated_urls.txt
            authenticated_urls.txt
            auth_only_urls.txt
            js_urls_unique.txt
            all_urls.txt
