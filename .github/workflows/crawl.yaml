name: Juice Shop DAST Full Scan

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  dast:
    runs-on: ubuntu-latest
    env:
      APP_URL: http://localhost:3000
      DB_FILE: /tmp/juice-shop.db

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Start Juice Shop in Docker
      - name: Start Juice Shop
        run: |
          docker run -d --rm --name juice-shop -p 3000:3000 \
            bkimminich/juice-shop:latest
          # wait until Juice Shop is ready
          echo "Waiting for Juice Shop to be ready..."
          for i in {1..30}; do
            curl -s $APP_URL > /dev/null && break || sleep 2
          done

      # 3. Register & login user, get JWT token
      - name: Register and login test user
        run: |
          export EMAIL="ci-user@example.com"
          export PASSWORD="ciUserPass123!"
          # Registration (ignore if exists)
          curl -s -X POST "$APP_URL/rest/user" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\",\"passwordRepeat\":\"$PASSWORD\",\"securityQuestion\":\"Your favorite color?\",\"securityAnswer\":\"blue\"}" || true
          # Login to get JWT
          TOKEN=$(curl -s -X POST "$APP_URL/rest/user/login" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$EMAIL\",\"password\":\"$PASSWORD\"}" | jq -r '.authentication.token')
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      # 4. Sanity check for protected endpoints
      - name: Sanity check authenticated endpoints
        run: |
          for endpoint in /rest/user/whoami /rest/order-history; do
            status=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $TOKEN" "$APP_URL$endpoint")
            if [[ "$status" == "401" ]]; then
              echo "ERROR: $endpoint returned 401, authentication failed"
              exit 1
            else
              echo "$endpoint accessible, status $status"
            fi
          done

      # 5. Crawl unauthenticated URLs
      - name: Crawl unauthenticated URLs
        run: |
          katana -u $APP_URL -d 5 -jsl -silent -o unauthenticated_urls.txt || true
          echo "Unauthenticated URLs count: $(wc -l < unauthenticated_urls.txt)"

      # 6. Crawl authenticated URLs
      - name: Crawl authenticated URLs
        run: |
          katana -u $APP_URL -d 5 -jsl -silent \
            -H "Authorization: Bearer $TOKEN" \
            -o authenticated_urls.txt || true
          echo "Authenticated URLs count: $(wc -l < authenticated_urls.txt)"

      # 7. Merge & filter real URLs
      - name: Combine real URLs
        run: |
          cat unauthenticated_urls.txt authenticated_urls.txt | \
            grep -E '^https?://' | sort -u > all_urls.txt
          echo "Total unique real URLs: $(wc -l < all_urls.txt)"

      # 8. Run OWASP ZAP full scan using discovered URLs
      - name: Run OWASP ZAP Full Scan
        run: |
          docker run -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-stable \
            zap-full-scan.py -t $APP_URL -r zap_report.html -u all_urls.txt || true

      # 9. Upload ZAP report as artifact
      - name: Upload ZAP report
        uses: actions/upload-artifact@v5
        with:
          name: zap-report
          path: zap_report.html
